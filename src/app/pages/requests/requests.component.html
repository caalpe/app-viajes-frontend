<div class="bg-gradient min-vh-100">
  <!-- Header -->
  <div class="header-wrapper">
    <div class="container-custom header-content">
      <h1 class="title">Mis Solicitudes</h1>
      <p class="subtitle">
        Gestiona las solicitudes de viajeros que quieren unirse a tus viajes
      </p>
    </div>
  </div>

  <!-- Main Content -->
  <div class="container-custom main-content">
    <!-- Tabs -->
    <div class="tabs-wrapper">
      <button
        (click)="setActiveTab('all')"
        [class.active]="activeTab === 'all'"
        class="tab-button"
      >
        Todas @if (allRequests.length > 0) {
        <span class="badge-count" [class.active]="activeTab === 'all'">{{
          allRequests.length
        }}</span>
        }
      </button>

      <button
        (click)="setActiveTab('uncompleted')"
        [class.active]="activeTab === 'uncompleted'"
        class="tab-button"
      >
        Viajes Pendientes @if (uncompletedTrips.length > 0) {
        <span
          class="badge-count"
          [class.active]="activeTab === 'uncompleted'"
          >{{ uncompletedTrips.length }}</span
        >
        }
      </button>

      <button
        (click)="setActiveTab('completed')"
        [class.active]="activeTab === 'completed'"
        class="tab-button"
      >
        Completos @if (completedTrips.length > 0) {
        <span class="badge-count" [class.active]="activeTab === 'completed'">{{
          completedTrips.length
        }}</span>
        }
      </button>

      <button
        (click)="setActiveTab('past')"
        [class.active]="activeTab === 'past'"
        class="tab-button"
      >
        Viajes Pasados @if (pastTrips.length > 0) {
        <span class="badge-count" [class.active]="activeTab === 'past'">{{
          pastTrips.length
        }}</span>
        }
      </button>
    </div>

    <!-- Loading / Content -->
    @if (loading) {
    <div class="text-center py-5">
      <div class="spinner-border text-primary" role="status"></div>
      <p class="mt-3">Cargando solicitudes...</p>
    </div>
    } @else {
    <div class="content-wrapper">
      <!-- All Tab -->
      @if (activeTab === 'all') { @if (filteredRequests.length > 0) { @for
      (request of filteredRequests; track request.id_participation) {
      <div class="card request-card mb-4">
        <div class="row g-0">
          <div class="col-md-3">
            <img
              [src]="
                request.trip?.image_url ||
                'https://images.unsplash.com/photo-1469854523086-cc02fe5d8800?w=400'
              "
              class="img-fluid rounded-start h-100 object-fit-cover"
              [alt]="request.trip?.title"
            />
          </div>

          <div class="col-md-9">
            <div class="card-body">
              <div
                class="d-flex justify-content-between align-items-start mb-3"
              >
                <div>
                  <h5 class="card-title mb-1">{{ request.trip?.title }}</h5>
                  <p class="text-muted mb-0 small">
                    <i class="bi bi-geo-alt me-1"></i
                    >{{ request.trip?.destination }}
                    <span class="mx-2">•</span>
                    <i class="bi bi-calendar me-1"></i
                    >{{ formatDate(request.trip?.start_date) }}
                  </p>
                </div>

                <span
                  class="badge"
                  [ngClass]="getStatusBadgeClass(request.status)"
                >
                  {{ getStatusText(request.status) }}
                </span>
              </div>

              <div class="d-flex align-items-center gap-3 mb-3">
                <img
                  [src]="getUserAvatar(request.id_user)"
                  class="rounded-circle"
                  style="cursor: pointer"
                  width="48"
                  height="48"
                  [alt]="getUserName(request.id_user)"
                  (click)="showUserProfile(request.id_user)"
                />
                <div
                  style="cursor: pointer"
                  (click)="showUserProfile(request.id_user)"
                >
                  <p class="mb-0 fw-semibold">
                    {{ getUserName(request.id_user) }}
                  </p>
                  <p class="mb-0 small text-muted">
                    Solicitud enviada {{ formatDate(request.created_at) }}
                  </p>
                </div>
              </div>

              @if (request.message) {
              <div class="alert alert-light mb-3">
                <i class="bi bi-chat-quote me-2"></i>
                <small>{{ request.message }}</small>
              </div>
              } @if (request.status === participationStatus.pending) {
              <div class="d-flex gap-2">
                <button
                  (click)="acceptRequest(request.id_participation)"
                  class="btn btn-success flex-fill"
                >
                  <i class="bi bi-check-circle me-1"></i>Aceptar
                </button>
                <button
                  (click)="rejectRequest(request.id_participation)"
                  class="btn btn-outline-secondary flex-fill"
                >
                  <i class="bi bi-x-circle me-1"></i>Rechazar
                </button>
              </div>
              }
            </div>
          </div>
        </div>
      </div>
      } } @else {
      <div class="text-center py-5">
        <i class="bi bi-inbox display-3 text-muted"></i>
        <p class="text-muted mt-3">No se han recibido solicitudes aún</p>
      </div>
      } }

      <!-- Uncompleted Tab -->
      @if (activeTab === 'uncompleted') { @if (uncompletedTrips.length > 0) {
      @for (trip of uncompletedTrips; track trip.id_trip) {
      <div class="card mb-4">
        <div class="row g-0">
          <div class="col-md-4">
            <img
              [src]="
                trip.image_url ||
                'https://images.unsplash.com/photo-1469854523086-cc02fe5d8800?w=600'
              "
              class="img-fluid rounded-start h-100 object-fit-cover"
              [alt]="trip.title"
            />
          </div>

          <div class="col-md-8">
            <div class="card-body">
              <h5 class="card-title">{{ trip.title }}</h5>
              <p class="text-muted mb-3 small">
                <i class="bi bi-geo-alt me-1"></i>{{ trip.destination }}
                <span class="mx-2">•</span>
                <i class="bi bi-calendar me-1"></i
                >{{ formatDate(trip.start_date) }} –
                {{ formatDate(trip.end_date) }}
              </p>

              <!-- Progress Bar (max_participants + colores) -->
              <div class="mb-3">
                <div
                  class="d-flex justify-content-between align-items-center mb-2"
                >
                  <span class="small fw-semibold">
                    <i class="bi bi-people me-1"></i>
                    {{ trip.accepted_participants || 0 }} /
                    {{ getTripCapacity(trip) }} plazas
                  </span>
                  <span class="small text-muted">
                    {{ getProgressPercent(trip) | number : "1.0-0" }}%
                  </span>
                </div>

                <div class="progress-bar">
                  <div
                    class="progress-fill"
                    [style.width.%]="getProgressPercent(trip)"
                  ></div>
                </div>

                <div
                  class="d-flex justify-content-between mt-2 small text-muted"
                >
                  <span>Mín: {{ trip.min_participants }}</span>
                  <span>Máx: {{ trip.max_participants || "∞" }}</span>
                </div>
              </div>

              @if (getTripParticipantsInfo(trip.id_trip!).length > 0) {
              <div class="mb-3">
                <h6 class="text-success mb-2">
                  <i class="bi bi-check-circle me-1"></i>
                  Participantes Aceptados ({{
                    getTripParticipantsInfo(trip.id_trip!).length
                  }})
                </h6>

                @for (participant of getTripParticipantsInfo(trip.id_trip!);
                track participant.id_user) {
                <div
                  class="d-flex align-items-center gap-3 p-2 bg-success bg-opacity-10 rounded mb-2"
                  style="cursor: pointer"
                  (click)="showUserProfile(participant.id_user)"
                >
                  <img
                    [src]="
                      participant.photo_url ||
                      'https://ui-avatars.com/api/?name=' +
                        participant.name.replace(' ', '+') +
                        '&size=32'
                    "
                    class="rounded-circle"
                    width="32"
                    height="32"
                    [alt]="participant.name"
                  />
                  <div class="flex-grow-1">
                    <span class="small fw-semibold d-block">{{
                      participant.name
                    }}</span>
                    @if (participant.average_rating > 0) {
                    <span class="text-muted small">
                      <i class="bi bi-star-fill text-warning"></i>
                      {{ participant.average_rating.toFixed(1) }}
                    </span>
                    }
                  </div>
                  <span class="badge bg-success">Aceptado</span>
                </div>
                }
              </div>
              } @if (getPendingRequests(trip.id_trip!).length > 0) {
              <div>
                <h6 class="mb-2">
                  <i class="bi bi-clock-history me-1 text-warning"></i>
                  Solicitudes Pendientes ({{
                    getPendingRequests(trip.id_trip!).length
                  }})
                </h6>

                @for (req of getPendingRequests(trip.id_trip!); track
                req.id_participation) {
                <div
                  class="bg-primary bg-opacity-10 rounded p-3 mb-2 border border-primary border-opacity-25"
                >
                  <div
                    class="d-flex align-items-center gap-2 mb-2"
                    style="cursor: pointer"
                    (click)="showUserProfile(req.id_user)"
                  >
                    <img
                      [src]="getUserAvatar(req.id_user)"
                      class="rounded-circle"
                      width="40"
                      height="40"
                      [alt]="getUserName(req.id_user)"
                    />
                    <div class="flex-grow-1">
                      <p class="mb-0 fw-semibold">
                        {{ getUserName(req.id_user) }}
                      </p>
                      <p class="mb-0 small text-muted">
                        <i class="bi bi-clock me-1"></i>
                        {{ formatDate(req.created_at) }}
                      </p>
                    </div>
                  </div>

                  @if (req.message) {
                  <div class="alert alert-light mb-2 py-2">
                    <i class="bi bi-chat-quote-fill me-1 text-primary"></i>
                    <small class="fst-italic">"{{ req.message }}"</small>
                  </div>
                  }

                  <div class="d-flex gap-2">
                    <button
                      (click)="acceptRequest(req.id_participation)"
                      class="btn btn-sm btn-success flex-fill"
                    >
                      Aceptar
                    </button>
                    <button
                      (click)="rejectRequest(req.id_participation)"
                      class="btn btn-sm btn-outline-secondary flex-fill"
                    >
                      Rechazar
                    </button>
                  </div>
                </div>
                }
              </div>
              }
            </div>
          </div>
        </div>
      </div>
      } } @else {
      <div class="text-center py-5">
        <i class="bi bi-inbox display-3 text-muted"></i>
        <p class="text-muted mt-3">No hay viajes incompletos</p>
      </div>
      } }

      <!-- Completed Tab -->
      @if (activeTab === 'completed') { @if (completedTrips.length > 0) { @for
      (trip of completedTrips; track trip.id_trip) {
      <div class="card mb-4">
        <div class="row g-0">
          <div class="col-md-4 position-relative">
            <img
              [src]="
                trip.image_url ||
                'https://images.unsplash.com/photo-1469854523086-cc02fe5d8800?w=600'
              "
              class="img-fluid rounded-start h-100 object-fit-cover"
              [alt]="trip.title"
            />
            <span class="badge bg-primary position-absolute top-0 start-0 m-3"
              >Completo - Próximo</span
            >
          </div>

          <div class="col-md-8">
            <div class="card-body">
              <h5 class="card-title">{{ trip.title }}</h5>
              <p class="text-muted mb-4 small">
                <i class="bi bi-geo-alt me-1"></i>{{ trip.destination }}
                <span class="mx-2">•</span>
                <i class="bi bi-calendar me-1"></i
                >{{ formatDate(trip.start_date) }}
              </p>

              <h6 class="text-success mb-2">
                <i class="bi bi-check-circle me-1"></i>
                Participantes ({{
                  getTripParticipantsInfo(trip.id_trip!).length
                }})
              </h6>

              <div class="row g-2">
                @for (participant of getTripParticipantsInfo(trip.id_trip!);
                track participant.id_user) {
                <div class="col-6">
                  <div
                    class="d-flex align-items-center gap-2 p-2 bg-success bg-opacity-10 rounded"
                    style="cursor: pointer"
                    (click)="showUserProfile(participant.id_user)"
                  >
                    <img
                      [src]="
                        participant.photo_url ||
                        'https://ui-avatars.com/api/?name=' +
                          participant.name.replace(' ', '+') +
                          '&size=24'
                      "
                      class="rounded-circle"
                      width="24"
                      height="24"
                      [alt]="participant.name"
                    />
                    <div class="flex-grow-1">
                      <span class="small">{{ participant.name }}</span>
                      @if (participant.average_rating > 0) {
                      <span class="text-warning small ms-1">
                        <i class="bi bi-star-fill" style="font-size: 0.7rem"></i
                        >{{ participant.average_rating.toFixed(1) }}
                      </span>
                      }
                    </div>
                  </div>
                </div>
                }
              </div>
            </div>
          </div>
        </div>
      </div>
      } } @else {
      <div class="text-center py-5">
        <i class="bi bi-inbox display-3 text-muted"></i>
        <p class="text-muted mt-3">No hay viajes completos aún</p>
      </div>
      } }

      <!-- Past Trips Tab -->
      @if (activeTab === 'past') { @if (pastTrips.length > 0) { @for (trip of
      pastTrips; track trip.id_trip) {
      <div class="card mb-4">
        <div class="row g-0">
          <div class="col-md-4 position-relative">
            <img
              [src]="
                trip.image_url ||
                'https://images.unsplash.com/photo-1469854523086-cc02fe5d8800?w=600'
              "
              class="img-fluid rounded-start h-100 object-fit-cover"
              [alt]="trip.title"
            />
            <span class="badge bg-secondary position-absolute top-0 start-0 m-3"
              >Viaje Pasado</span
            >
          </div>

          <div class="col-md-8">
            <div class="card-body">
              <h5 class="card-title">{{ trip.title }}</h5>
              <p class="text-muted mb-4 small">
                <i class="bi bi-geo-alt me-1"></i>{{ trip.destination }}
                <span class="mx-2">•</span>
                <i class="bi bi-calendar me-1"></i
                >{{ formatDate(trip.start_date) }}
              </p>

              <h6 class="mb-3">
                <i class="bi bi-people text-primary me-1"></i>
                Participantes ({{
                  getTripParticipantsInfo(trip.id_trip!).length
                }})
              </h6>

              @for (participant of getTripParticipantsInfo(trip.id_trip!); track
              participant.id_user) {
              <div class="border rounded p-3 mb-3">
                <div
                  class="d-flex justify-content-between align-items-center mb-2"
                >
                  <div
                    class="d-flex align-items-center gap-2"
                    style="cursor: pointer"
                    (click)="showUserProfile(participant.id_user)"
                  >
                    <img
                      [src]="
                        participant.photo_url ||
                        'https://ui-avatars.com/api/?name=' +
                          participant.name.replace(' ', '+') +
                          '&size=40'
                      "
                      class="rounded-circle"
                      width="40"
                      height="40"
                      [alt]="participant.name"
                    />
                    <div>
                      <p class="mb-0 fw-semibold">{{ participant.name }}</p>
                      <p class="mb-0 small text-muted">
                        Viajó contigo @if (participant.average_rating > 0) {
                        <span class="text-warning ms-2">
                          <i class="bi bi-star-fill"></i>
                          {{ participant.average_rating.toFixed(1) }}
                        </span>
                        }
                      </p>
                    </div>
                  </div>

                  @if (!isCurrentUser(participant.id_user)) { @if
                  (hasRated(trip.id_trip!, participant.id_user)) {
                  <button class="btn btn-sm btn-outline-secondary" disabled>
                    <i class="bi bi-check2-circle me-1"></i> Ya valorado
                  </button>
                  } @else {
                  <button
                    (click)="
                      toggleRatingForm(trip.id_trip!, participant.id_user)
                    "
                    class="btn btn-sm btn-outline-primary"
                  >
                    <i class="bi bi-star me-1"></i>
                    {{
                      expandedRatings[trip.id_trip! + ":" + participant.id_user]
                        ? "Cancelar"
                        : "Valorar"
                    }}
                  </button>
                  } }
                </div>

                @if (expandedRatings[trip.id_trip! + ':' + participant.id_user])
                {
                <div class="bg-light rounded p-3">
                  <label class="form-label small fw-semibold"
                    >Tu Valoración (1-10)</label
                  >

                  <div class="d-flex gap-2 mb-3 flex-wrap">
                    @for (score of [1,2,3,4,5,6,7,8,9,10]; track score) {
                    <button
                      (click)="
                        setRating(trip.id_trip!, participant.id_user, score)
                      "
                      class="btn btn-link p-0"
                    >
                      <i
                        class="bi fs-4"
                        [class.bi-star-fill]="
                          getRatingValue(trip.id_trip!, participant.id_user) >=
                          score
                        "
                        [class.bi-star]="
                          getRatingValue(trip.id_trip!, participant.id_user) <
                          score
                        "
                        [class.text-warning]="
                          getRatingValue(trip.id_trip!, participant.id_user) >=
                          score
                        "
                        [class.text-muted]="
                          getRatingValue(trip.id_trip!, participant.id_user) <
                          score
                        "
                      ></i>
                    </button>
                    }
                  </div>

                  <label class="form-label small fw-semibold"
                    >Comentario (Opcional)</label
                  >
                  <textarea
                    [value]="
                      getCommentValue(trip.id_trip!, participant.id_user)
                    "
                    (input)="
                      setComment(
                        trip.id_trip!,
                        participant.id_user,
                        $any($event.target).value
                      )
                    "
                    class="form-control mb-3"
                    rows="3"
                    placeholder="Comparte tu experiencia..."
                  ></textarea>

                  <button
                    (click)="submitRating(trip.id_trip!, participant.id_user)"
                    [disabled]="
                      getRatingValue(trip.id_trip!, participant.id_user) === 0
                    "
                    class="btn btn-primary w-100"
                  >
                    Enviar Valoración
                  </button>
                </div>
                }
              </div>
              }
            </div>
          </div>
        </div>
      </div>
      } } @else {
      <div class="text-center py-5">
        <i class="bi bi-inbox display-3 text-muted"></i>
        <p class="text-muted mt-3">No hay viajes pasados aún</p>
      </div>
      } }
    </div>
    }
  </div>

  <!-- User Profile Modal -->
  @if (selectedUserId !== null) {
  <app-user-profile-modal
    [user]="userProfiles[selectedUserId]"
    (close)="closeUserProfile()"
  ></app-user-profile-modal>
  }
</div>
